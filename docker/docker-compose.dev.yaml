name: idpass-data-collection-dev
services:
  # PostgreSQL database
  postgres:
    image: postgres:15
    restart: always
    env_file: ./.env
    volumes:
      - postgres-data-dev:/var/lib/postgresql/data
      - ./init-reset-dbs.sh:/docker-entrypoint-initdb.d/init-reset-dbs.sh
    ports:
      - "5432:5432"
    networks:
      - datacollect-network-dev
    command: ["postgres"]

  # pgAdmin for database management (optional)
  pgadmin:
    image: dpage/pgadmin4:9
    env_file: ./.env
    ports:
      - "5050:80"
    depends_on:
      - postgres
    networks:
      - datacollect-network-dev

  # DataCollect Sync Server - Development mode
  sync-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: backend
    develop:
      watch:
        - action: sync
          path: ../packages/backend
          target: /app/packages/backend
          ignore:
            - node_modules/
            - dist/
        - action: sync
          path: ../packages/datacollect
          target: /app/packages/datacollect
          ignore:
            - node_modules/
            - dist/
        - action: rebuild
          path: ../package.json
        - action: rebuild
          path: ../pnpm-lock.yaml
    env_file: ./.env
    ports:
      - "${SYNC_SERVER_PORT:-3000}:3000"
      - "9229:9229" # Node.js debugger port
    restart: unless-stopped
    depends_on:
      - postgres
    networks:
      - datacollect-network-dev

  # Admin UI - Development mode
  admin-ui:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: admin-ui
    develop:
      watch:
        - action: sync
          path: ../packages/admin
          target: /app/packages/admin
          ignore:
            - node_modules/
            - dist/
        - action: rebuild
          path: ../package.json
        - action: rebuild
          path: ../pnpm-lock.yaml
    restart: unless-stopped
    environment:
      - VITE_API_URL=http://localhost:3000
    ports:
      - "5173:5173"
    depends_on:
      - sync-server
    networks:
      - datacollect-network-dev

  # Mobile App - Browser Development mode
  mobile-app:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: mobile-app
    develop:
      watch:
        - action: sync
          path: ../packages/mobile
          target: /app/packages/mobile
          ignore:
            - node_modules/
            - dist/
        - action: sync
          path: ../packages/datacollect
          target: /app/packages/datacollect
          ignore:
            - node_modules/
            - dist/
        - action: rebuild
          path: ../package.json
        - action: rebuild
          path: ../pnpm-lock.yaml
    environment:
      - VITE_DB_ENCRYPTION_PASSWORD=password
      - VITE_DEVELOP=true
      - VITE_DEBUG=true
      - VITE_FEATURE_DYNAMIC=true
    ports:
      - "8081:8081"
    depends_on:
      - sync-server
    networks:
      - datacollect-network-dev

volumes:
  postgres-data-dev:

networks:
  datacollect-network-dev:
    driver: bridge
